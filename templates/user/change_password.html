{% extends "user/base_user.html" %}

{% block title %}修改密码 - 用户中心{% endblock %}

{% block content %}
<div class="p-6">
  <!-- 页面标题 -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">修改密码</h1>
    <p class="text-gray-600">定期修改密码有助于保护您的账户安全</p>
  </div>
  
  <div class="max-w-md mx-auto">
    <div class="bg-white rounded-lg shadow">
      <div class="p-6 border-b">
        <h2 class="text-lg font-semibold">修改密码</h2>
      </div>
      
      <div class="p-6">
        <form class="space-y-6" method="post" >
          
          <!-- 新密码 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">新密码</label>
            <div class="relative">
              <input type="password" name="new_password" class="w-full border rounded-lg px-3 py-2 pr-10" placeholder="请输入新密码">
              <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="mt-2 space-y-1">
              <div class="flex items-center text-xs">
                <i class="fas fa-check text-green-500 mr-1"></i>
                <span class="text-gray-500">至少6个字符</span>
              </div>
              <div class="flex items-center text-xs">
                <i class="fas fa-check text-green-500 mr-1"></i>
                <span class="text-gray-500">包含字母和数字</span>
              </div>
            </div>
          </div>
          
          <!-- 确认新密码 -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">确认新密码</label>
            <div class="relative">
              <input type="password" name="confirm_password" class="w-full border rounded-lg px-3 py-2 pr-10" placeholder="请再次输入新密码">
              <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          
          <!-- 安全提示 -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start">
              <i class="fas fa-shield-alt text-blue-500 mt-1 mr-3"></i>
              <div>
                <h4 class="font-medium text-blue-800">安全提示</h4>
                <ul class="text-sm text-blue-700 mt-1 space-y-1">
                  <li>• 不要使用与其他网站相同的密码</li>
                  <li>• 建议定期更换密码</li>
                  <li>• 避免使用生日、电话号码等简单密码</li>
                </ul>
              </div>
            </div>
          </div>
          
          <!-- 操作按钮 -->
          <div class="flex justify-end space-x-3">
            <button type="button" class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-200">取消</button>
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">确认修改</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
<script>
// 等待DOM完全加载
$(document).ready(function() {
    
 
    // 表单提交处理
    $('form').on('submit', function(event) {
        event.preventDefault(); // 阻止表单默认提交
        
        // 获取输入值
        const newPassword = $('input[name="new_password"]').val();
        const confirmPassword = $('input[name="confirm_password"]').val();
        
        // 前端验证
        if (!validateForm(newPassword, confirmPassword)) {
            return;
        }
        
        // 显示加载状态
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.text();
        submitBtn.prop('disabled', true).text('修改中...');
        
        // 发送AJAX请求
        $.ajax({
            url: '/user/change_password',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                new_password: newPassword,
                confirm_password: confirmPassword
            }),
            success: function(response) {
                if (response.success) {
                    // 显示成功消息
                    alert(response.message);
                    // 清空表单
                    $('form')[0].reset();
                    // 重置密码可见性图标
                    $('.fa-eye').removeClass('fa-eye-slash').addClass('fa-eye');
                    // 确保密码框类型为password
                    $('input[name="new_password"]').attr('type', 'password');
                    $('input[name="confirm_password"]').attr('type', 'password');
                } else {
                    // 显示错误消息
                    alert(response.message);
                }
            },
            error: function() {
                alert('网络错误，请稍后重试');
            },
            complete: function() {
                // 恢复按钮状态
                submitBtn.prop('disabled', false).text(originalText);
            }
        });
    });
    
    // 表单验证函数
    function validateForm(newPassword, confirmPassword) {
        // 检查是否为空
        if (!newPassword || !confirmPassword) {
            alert('新密码和确认新密码不能为空');
            return false;
        }
        
        // 检查两次输入是否相同
        if (newPassword !== confirmPassword) {
            alert('两次输入的密码不一致');
            return false;
        }
        
        // 检查密码长度
        if (newPassword.length < 6) {
            alert('密码长度至少为6个字符');
            return false;
        }
        
        // 检查是否包含字母和数字
        const hasLetter = /[a-zA-Z]/.test(newPassword);
        const hasNumber = /[0-9]/.test(newPassword);
        
        if (!hasLetter || !hasNumber) {
            alert('密码必须包含字母和数字');
            return false;
        }
        
        return true;
    }

    // 取消按钮事件
    $('button.bg-gray-100').on('click', function() {
        // 确认是否要取消
        if (confirm('确定要取消修改密码吗？所有输入的内容将被清空。')) {
            $('form')[0].reset();
            // 重置密码可见性图标
            $('.fa-eye').removeClass('fa-eye-slash').addClass('fa-eye');
            // 确保密码框类型为password
            $('input[name="new_password"]').attr('type', 'password');
            $('input[name="confirm_password"]').attr('type', 'password');
        }
    });

    // 密码可见性切换
    $('.fa-eye').on('click', function() {
        const input = $(this).closest('div').find('input[type="password"]');
        const type = input.attr('type') === 'password' ? 'text' : 'password';
        input.attr('type', type);
        $(this).toggleClass('fa-eye fa-eye-slash');
    });
});
</script>
{% endblock %}